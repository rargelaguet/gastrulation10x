---
title: "Dimensionality reduction using scran + scater"
---
  
```{r load_modules, echo=FALSE, include=FALSE}
library(SingleCellExperiment)
library(scran)
library(scater)
library(batchelor)
```

# Define settings

Define I/O
```{r define_io, echo=FALSE}
source("/Users/ricard/gastrulation10x/settings.R")
io$outdir <- paste0(io$basedir,"/results/dimensionality_reduction")
```

Define options
```{r}
opts$stages <- c(
  "E6.5",
  "E6.75",
  "E7.0",
  "E7.25",
  "E7.5",
  "E7.75",
  "E8.0",
  "E8.25",
  "E8.5",
  "mixed_gastrulation"
)

opts$celltypes = c(
   "Epiblast",
   "Primitive_Streak",
   "Caudal_epiblast",
   "PGC",
   "Anterior_Primitive_Streak",
   "Notochord",
   "Def._endoderm",
   "Gut",
   "Nascent_mesoderm",
   "Mixed_mesoderm",
   "Intermediate_mesoderm",
   "Caudal_Mesoderm",
   "Paraxial_mesoderm",
   "Somitic_mesoderm",
   "Pharyngeal_mesoderm",
   "Cardiomyocytes",
   "Allantois",
   "ExE_mesoderm",
   "Mesenchyme",
   "Haematoendothelial_progenitors",
   "Endothelium",
   "Blood_progenitors_1",
   "Blood_progenitors_2",
   "Erythroid1",
   "Erythroid2",
   "Erythroid3",
   "NMP",
   "Rostral_neurectoderm",
   "Caudal_neurectoderm",
   "Neural_crest",
   "Forebrain_Midbrain_Hindbrain",
   "Spinal_cord",
   "Surface_ectoderm",
   "Visceral_endoderm",
   "ExE_endoderm",
   "ExE_ectoderm",
   "Parietal_endoderm"
)
opts$batch_correction <- FALSE
```

Update sample metadata
```{r load_metadata, echo=FALSE}
sample_metadata <- sample_metadata %>%
  .[stage%in%opts$stages & celltype%in%opts$celltypes] %>%
  droplevels
# table(sample_metadata$stage)
# table(sample_metadata$celltype)
```

# Load data

Load RNA expression data as SingleCellExperiment object
```{r load_data, echo=FALSE}
sce <- load_SingleCellExperiment(io$sce, 
  cells = sample_metadata$cell, 
  remove_non_expressed_genes = TRUE,
  normalise = TRUE
)
dim(sce)
```

Add sample metadata to the colData of the SingleCellExperiment
```{r}
colData(sce) <- sample_metadata %>% as.data.frame %>% tibble::column_to_rownames("cell") %>%
  .[colnames(sce),] %>% DataFrame()
```

Change gene names from ENSEMBL to symbols
```{r}
# gene_metadata <- fread(io$gene_metadata) %>% .[,c("ens_id","symbol")] %>%
#   .[symbol!="" & ens_id%in%rownames(sce)]
# 
# gene_metadata$symbol[duplicated(gene_metadata$symbol)]
# 
# sce <- sce[rownames(sce)%in%gene_metadata$ens_id,]
# foo <- gene_metadata$symbol; names(foo) <- gene_metadata$ens_id
# new.names <- foo[rownames(sce)]
# 
# # Sanity cehcks
# stopifnot(sum(is.na(new.names))==0)
# stopifnot(sum(duplicated(new.names))==0)
# 
# # Set names
# rownames(sce) <- new.names
```

# Parse data

Select HVG
```{r}
if (opts$batch_correction) {
  decomp <- modelGeneVar(sce, block=sce$stage)
} else {
  decomp <- modelGeneVar(sce)
}
decomp <- decomp[decomp$mean > 0.01,]
hvgs <- rownames(decomp)[decomp$p.value <= 0.05]

# Subset SingleCellExperiment
sce_filt <- sce[hvgs,]
dim(sce_filt)
```

Use gene markers as HVGs
```{r}
# io$atlas.marker_genes <- "/Users/ricard/data/gastrulation10x/results/marker_genes/E8.5/marker_genes.txt.gz"
# 
# marker_genes.dt <- fread(io$atlas.marker_genes)
# marker_genes.dt <- marker_genes.dt[,head(.SD,n=50),by="celltype"]
# marker_genes <- unique(marker_genes.dt$gene)
# marker_genes <- marker_genes[marker_genes%in%rownames(sce)]
# length(marker_genes)
```

Regress out covariates
```{r}
# data <- scale(t(logcounts(sce_filt)), center = T, scale = F)
# data_regressed <- apply(data, 2, function(x) {
#   lm.out <- lm(formula=expr~covariate, data=data.frame(expr=x, covariate=factor(sce_filt$stage)));
#   residuals <- lm.out[["residuals"]]+lm.out[["coefficients"]][1]
# })
```

# PCA

```{r}
npcs <- 15

if (opts$batch_correction) {
  # pca <- multiBatchPCA(sce_filt, batch=sce_filt$sample)
  pca <- multiBatchPCA(sce_filt, d = npcs, batch=sce_filt$stage)
  pca.corrected <- reducedMNN(pca)$corrected
  colnames(pca.corrected) <- paste0("PC",1:ncol(pca.corrected))
  pca.corrected <- pca.corrected[match(colnames(sce_filt),rownames(pca.corrected)),]
  reducedDim(sce_filt, "PCA") <- pca.corrected
} else {
  # reducedDim(sce_filt, "PCA") <- irlba::prcomp_irlba(data, n=npcs)$x[,1:npcs]
  sce_filt <- runPCA(sce_filt, ncomponents = npcs, ntop=nrow(sce_filt))  
}
```


```{r}
# all(rownames(pca.corrected2) == rownames(reducedDim(sce_filt, "PCA")))
# all(rownames(pca.corrected2) == colnames(sce_filt))
```

Plot PCA
```{r}
plotPCA(sce_filt, colour_by="celltype", ncomponents = c(1,2)) +
  scale_color_manual(values=opts$celltype.colors)
```

```{r}
# cor(colMeans(assay(sce,"logcounts")), reducedDim(sce_filt, "PCA"))
```

# UMAP

Run UMAP
```{r}
set.seed(42)
sce_filt <- runUMAP(sce_filt, dimred="PCA", n_neighbors = 35, min_dist = 0.45)
reducedDim(sce, "UMAP") <- reducedDim(sce_filt, "UMAP") 
```

Plot UMAP
```{r}
to.plot <- reducedDim(sce_filt,"UMAP") %>% as.data.table %>% 
  .[,cell:=colnames(sce_filt)] %>%
    merge(sample_metadata, by="cell")

p <- ggplot(to.plot, aes(x=V1, y=V2, fill=celltype)) +
  geom_point(size=1.5, shape=21, stroke=0.2) +
  scale_fill_manual(values=opts$celltype.colors) +
  theme_classic() +
  theme(
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position="none",
    legend.title=element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=5, height=3, useDingbats = F)
print(p)
# dev.off()
```

```{r}
# to.plot <- to.plot[!celltype%in%c("ExE_ectoderm","Parietal_endoderm")]
```



# Explore

```{r}
for (i in unique(to.plot$stage)) {
  
  to.plot_i <- to.plot %>% copy %>%
    .[,alpha:=1.0] %>%
    .[stage!=i,c("celltype","alpha"):=list("None",0.25)]
  
  # p <- ggplot(to.plot_i, aes(x=V1, y=V2, fill=celltype, alpha=alpha)) +
  p <- ggplot() +
    ggrastr::geom_point_rast(aes(x=-V1, y=V2), size=1, color="grey", alpha=0.25, data=to.plot_i[stage!=i]) +
    ggrastr::geom_point_rast(aes(x=-V1, y=V2, fill=celltype), size=1.5, shape=21, stroke=0.1, alpha=1.0, data=to.plot_i[stage==i]) +
    labs(title=i) +
    # scale_size_manual(values = c("TRUE"=0.55, "FALSE"=0.15)) +
    scale_fill_manual(values=opts$celltype.colors) +
    theme_classic() +
    theme(
      axis.title = element_blank(),
      axis.text = element_blank(),
      axis.ticks = element_blank(),
      axis.line = element_blank(),
      legend.position="none"
    )
  
  # pdf(sprintf("%s/umap_%s.pdf",io$outdir,i), width=5, height=5)
  print(p)
  # dev.off()
}
```


# TEST

Load batch-corrected PCs
```{r}
pca.mtx <- readRDS("/Users/ricard/data/gastrulation10x/original/corrected_pcas.rds")[["all"]]
```

```{r}
to.plot <- pca.mtx %>% as.data.table %>% 
  .[,cell:=rownames(pca.mtx)] %>%
    merge(sample_metadata, by="cell")

p <- ggplot(to.plot, aes(x=PC3, y=PC4, fill=celltype)) +
  geom_point(size=1.5, shape=21, stroke=0.2) +
  scale_fill_manual(values=opts$celltype.colors) +
  theme_classic() +
  # labs(x="PC3", y="PC2") +
  theme(
    # axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position="none",
    legend.title=element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=5, height=3, useDingbats = F)
print(p)
# dev.off()
```

t-SNE
```{r}
tsne.mtx <- Rtsne::Rtsne(pca.mtx, check_duplicates = FALSE, pca = FALSE)
```


```{r}
to.plot <- tsne.mtx$Y %>% as.data.table %>% 
  .[,cell:=rownames(pca.mtx)] %>%
    merge(sample_metadata[,c("cell","celltype")], by="cell")

p <- ggplot(to.plot, aes(x=V1, y=V2, fill=celltype)) +
  geom_point(size=1.5, shape=21, stroke=0.2) +
  scale_fill_manual(values=opts$celltype.colors) +
  theme_classic() +
  labs(x="tSNE-1", y="tSNE-2") +
  theme(
    # axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position="none",
    legend.title=element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=5, height=3, useDingbats = F)
print(p)
# dev.off()
```