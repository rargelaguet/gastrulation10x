---
title: "Dimensionality reduction using Seurat"
---
  
```{r load_modules, echo=FALSE, include=FALSE}
library(Seurat)
```

# Define settings

Define I/O
```{r define_io, echo=FALSE}
source("/Users/ricard/gastrulation10x/settings.R")
io$outdir <- paste0(io$basedir,"/results/dimensionality_reduction")
```

Define options
```{r}
opts$celltypes = c(
	"Epiblast",
	"Primitive_Streak",
	"Caudal_epiblast",
	"PGC",
	"Anterior_Primitive_Streak",
	"Notochord",
	"Def._endoderm",
	"Gut",
	"Nascent_mesoderm",
	"Mixed_mesoderm",
	"Intermediate_mesoderm",
	"Caudal_Mesoderm",
	"Paraxial_mesoderm",
	"Somitic_mesoderm",
	"Pharyngeal_mesoderm",
	"Cardiomyocytes",
	"Allantois",
	"ExE_mesoderm",
	"Mesenchyme",
	"Haematoendothelial_progenitors",
	"Endothelium",
	"Blood_progenitors_1",
	"Blood_progenitors_2",
	"Erythroid1",
	"Erythroid2",
	"Erythroid3",
	"NMP",
	"Rostral_neurectoderm",
	"Caudal_neurectoderm",
	"Neural_crest",
	"Forebrain_Midbrain_Hindbrain",
	"Spinal_cord",
	"Surface_ectoderm",
	"Visceral_endoderm",
	"ExE_endoderm",
	"ExE_ectoderm",
	"Parietal_endoderm"
)

opts$stages <- c(
  # "E6.5",
  # "E6.75",
  # "E7.0",
  # "E7.25",
  # "E7.5",
  # "E7.75",
  # "E8.0",
  # "E8.25",
  "E8.5"
  # "mixed_gastrulation"
)
```

Update sample metadata
```{r load_metadata, echo=FALSE}
sample_metadata <- sample_metadata %>%
  .[stage%in%opts$stages & celltype%in%opts$celltypes]
table(sample_metadata$stage)
table(sample_metadata$celltype)
```

# Load data

Load RNA expression data as a SingleCellExperiment object
```{r}
sce <- readRDS(io$rna.sce)[,sample_metadata$cell]
dim(sce)
```

<!-- Load RNA expression data as Seurat object -->
<!-- ```{r load_data, echo=FALSE} -->
<!-- seurat <- readRDS(io$seurat)[,sample_metadata$cell] -->
<!-- dim(seurat) -->
<!-- ``` -->

Convert SCE to Seurat
```{r}
seurat <- as.Seurat(sce)
```

Add metadata to the Seurat object
```{r}
foo <- sample_metadata %>% as.data.frame %>% tibble::column_to_rownames("cell") %>%
  .[colnames(seurat),]

stopifnot(colnames(seurat) == rownames(foo))
# seurat <- AddMetaData(seurat, foo)  # not working????
seurat@meta.data <- foo
```


# Parse data 

Remove genes that are not expressed
```{r}
foo <- Matrix::rowMeans(seurat@assays$RNA@counts)
seurat <- subset(seurat, features = names(which(foo>1e-6)))
```

Normalise
```{r}
# SCTransform
seurat <- SCTransform(seurat)

# LogNormalize
# seurat <- NormalizeData(seurat, normalization.method = "LogNormalize")
```

Scale (only if using logNorm)
```{r}
# seurat <- ScaleData(seurat, vars.to.regress = "nFeature_RNA")
```

Change gene names from ENSEMBL to symbols
```{r}
# gene_metadata <- fread(io$gene_metadata) %>% .[,c("ens_id","symbol")] %>%
#   .[symbol!="" & ens_id%in%rownames(seurat)]
# 
# seurat <- seurat[rownames(seurat)%in%gene_metadata$ens_id,]
# foo <- gene_metadata$symbol; names(foo) <- gene_metadata$ens_id
# new.names <- foo[rownames(seurat)]
# 
# # Sanity cehcks
# stopifnot(sum(is.na(new.names))==0)
# stopifnot(sum(duplicated(new.names))==0)
# 
# new.names[duplicated(new.names)]
# 
# # Rename seurat objects manually
# rownames(seurat@assays$SCT@counts) <- new.names
# rownames(seurat@assays$SCT@data) <- new.names
# # rownames(seurat@assays$SCT@scale.data) <- new.names
# seurat[["SCT"]]@meta.features <- data.frame(row.names=new.names)
```


# Select HVG

Option 1, using FindVariableFeatures
```{r}
seurat <- FindVariableFeatures(seurat, selection.method = 'vst', nfeatures = 1000, assay="SCT")
# length(seurat@assays$RNA@var.features)
```

Option 2, using precomputed marker genes
```{r}
# marker_genes.dt <- fread(io$atlas.marker_genes)
# hvg <- unique(marker_genes.dt$ens_id)
# hvg <- hvg[hvg%in%rownames(seurat)]
# 
# seurat@assays$RNA@var.features <- hvg
```

# Dimensionality reduction

PCA 
```{r message=FALSE}
seurat <- RunPCA(seurat, 
  features = VariableFeatures(seurat, assay="SCT"),
  assay = "SCT",
  npcs = 25,
  verbose = FALSE
)
```

<!-- Correlation between PCs and batch -->
```{r}
# r <- cor(
#   seurat@reductions$pca@cell.embeddings,
#   as.numeric(as.factor(seurat@meta.data$batch))
# )[,1]
# r
```

UMAP
```{r}
seurat <- RunUMAP(seurat, 
  dims = 1:25,
  reduction = "pca",
  n.neighbors = 30,
  min.dist = 0.3
)
```

# Plot 

```{r}
Idents(seurat) <- "celltype"

p <- DimPlot(seurat, label = FALSE, reduction = 'umap', cols = opts$celltype.colors) + 
  NoLegend() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank()
  )

print(p)
```

```{r}
Idents(seurat) <- "sample"

p <- DimPlot(seurat, label = FALSE, reduction = 'umap') + 
  NoLegend() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank()
  )

print(p)
```

Explore marker genes
```{r}
# genes.to.plot <- c("Apom")
# FeaturePlot(seurat, features = genes.to.plot, reduction='umap')
```


