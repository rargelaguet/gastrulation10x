---
title: ""
output: 
  BiocStyle::html_document: 
    fig_width: 10
    fig_height: 8
---


```{r}
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(MOFA2))
```

<!-- Define I/O and options -->
```{r}
source("/Users/ricard/gastrulation10x/mofa/load_settings.R")
```

<!-- Load sample metadata -->
```{r}
sample_metadata <- fread(io$sample.metadata) %>%
  .[,c("cell","sample","stage","lineage10x","lineage10x_2")]
```

<!-- Load model -->
```{r}
file <- paste0(io$basedir,"/mofa/hdf5/E6.5-E7.25_1.hdf5")
model <- load_model(file, remove_outliers = T)
```

<!-- Add sample metadata to the model -->
```{r}
cells <- as.character(unname(unlist(samples(model))))
sample_metadata_filt <- sample_metadata %>% setkey(cell) %>% .[cells]
stopifnot(all(cells==sample_metadata_filt$cell))

sample_metadata_filt[,lineage10x:=NULL]
sample_metadata_filt %>% setnames("lineage10x_2","lineage")
sample_metadata_filt %>% .[,group:=paste(stage,sample,sep="_")] %>% .[,sample:=NULL]
sample_metadata_filt %>% setnames("cell","sample")

model@samples_metadata <- sample_metadata_filt
```

<!-- Subset and rename groups -->
```{r}
groups(model) <- c("E6.5 (1)", "E6.5 (2)", "E7.0 (1)", "E7.0 (2)", "E7.25 (1)", "E7.25 (2)")
```

<!-- Subset factors -->
```{r}
# r2 <- model@cache$variance_explained$r2_per_factor
# factors <- sapply(r2, function(x) x[,"RNA"]>0.001)
# model <- subset_factors(model, which(apply(factors,1,sum) >= 1))
# factors(model) <- paste("Factor",1:get_dimensions(model)[["K"]], sep=" ")
```

<!-- Save model as RDS file -->
```{r}
# model@expectations$Y <- NULL
saveRDS(model, "/Users/ricard/data/gastrulation10x/mofa/model.rds")
```

<!-- Plot factors correlation -->
```{r}
# pdf(paste0(io$pdfdir,"/factor_correlation.pdf"), width=6, height=6)
# plot_factor_cor(model)
# dev.off()
```

